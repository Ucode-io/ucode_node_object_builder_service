[
    {
        "$lookup": {
            "from": "shokhrukh_users",
            "localField": "shokhrukh_user_id",
            "foreignField": "guid",
            "as": "shokhrukh_user_id_data"
        }
    },
    {
        "$group": {
            "_id": {
                "type": "$type",
                "branch": "$branch"
            },
            "data": {
                "$push": {
                    "shokhrukh_user_id": "$shokhrukh_user_id",
                    "shokhrukh_user_id_data": {
                        "$arrayElemAt": [
                            "$shokhrukh_user_id_data",
                            0
                        ]
                    }
                }
            }
        }
    },
    {
        "$lookup": {
            "from": "shokhrukh_users",
            "localField": "shokhrukh_user_id",
            "foreignField": "guid",
            "as": "shokhrukh_user_id_data"
        }
    },
    {
        "$group": {
            "_id": "$_id.type",
            "data": {
                "$push": {
                    "branch": "$_id.branch",
                    "data": "$data"
                }
            }
        }
    },
    {
        "$addFields": {
            "type": "$_id"
        }
    }
]